#Save workspace
```{r}
save.image("~/Github/RLB/size_glacial/2023Paleobio/.RData")
source("setup.R")
```

Relevant parts of DatabaseGuide.rmd should have been run to assemble the local database. 
#Connect to database
```{r}
require(RPostgreSQL)
PostgreSQL(max.con = 16,fetch.default.rec = 500,force.reload = FALSE)
driver <- dbDriver("PostgreSQL");con <- dbConnect(driver,user="vsyverson",password="gymnogyps",dbname="rlb")
test <- fetch(dbSendQuery(con,"select * from helloworld;"))
test;rm(test)
#or run setup.R
```
#Get chronologies for pits
##Import 14C dates table
Import and clean 14C age table. Fake sample numbers have been added and duplicates have had "a", "b", "c" added to distinguish them.
```{r}
source("setup.R")
c14 <- read.xlsx("driveDLs/c14.xlsx",sheet="Summary")
dupno <- c14[duplicated(c14$SampleNo),]$SampleNo
subset(c14,c14$SampleNo%in%dupno)
```
##Bin dates by pit
keep only those pits that are in the morphometric data set and only the applicable dates
```{r}
c14.clean <- c14[,1:10]
c14.clean <- c14.clean[-grep("&gt;",c14.clean$Uncal14CYBP),]
c14.clean <- c14.clean[-which(c14.clean$Quality%in%c(0,1,"&gt;30 kD","Chitin","Wood")),]
c14.clean$Uncal14CYBP <- as.numeric(c14.clean$Uncal14CYBP)
c14.clean$Uncal14CSE <- as.numeric(c14.clean$Uncal14CSE)
pit.all <- split.data.frame(c14.clean,c14.clean$Pit)
pit.all$`61/67` <- rlist::list.stack(list(pit.all$'61',pit.all$`61/67`,pit.all$'67'))
measPits <- array()
for (m in 1:length(meas)){
  for (n in 1:length(meas[[m]])){
    measPits <- unique(c(measPits,meas[[m]][[n]]$Pit))
  }
}
usePits <- intersect(unique(c14$Pit),measPits)
pit <- pit.all[which(names(pit.all)%in%usePits)]
sapply(pit,nrow)
```
##load Oxcal
```{r}
require(oxcAAR);require(ggridges)
source("functions.R")
quickSetupOxcal(path="/home/vsyverson/R/x86_64-pc-linux-gnu-library/4.0/oxcAAR/")
#or run setup.R
```

##calculate pit ages
###test
```{r}
pit[[9]][,c("Uncal14CYBP","Uncal14CSE")] <- as.numeric(as.matrix(pit[[9]][,c("Uncal14CYBP","Uncal14CSE")]))
test <- oxcalCalibrate(pit[[9]]$Uncal14CYBP,pit[[9]]$Uncal14CSE,pit[[9]]$SampleNo)
plot(test)
medianProbDist(test$begin$posterior_probabilities)$dates
medianProbDist(test$end$posterior_probabilities)$dates
```

###main loop that takes forever
```{r}
oxcalResults <- vector("list",length(pit));names(oxcalResults) <- names(pit)

for (i in which(sapply(pit,nrow)==1)){
  test <- oxcalCalibrate(pit[[i]]$Uncal14CYBP,pit[[i]]$Uncal14CSE,pit[[i]]$SampleNo)
  oxcalResults[[i]] <- test
}

for (i in which(sapply(pit,nrow)!=1 & sapply(oxcalResults,length)==0)){
  test <- unitDates.kde(pit[i])
  oxcalResults[[i]] <- test
  save(oxcalResults,file="oxcalResults/oxcalResults.Rdata")
}

failkde <- which(!sapply(oxcalResults,
                       function(x) any(x$pit$posterior_probabilities$probabilities!=0)))
for (i in failkde){
  test <- unitDates.kde(pit[i])
  oxcalResults[[i]] <- test
  save(oxcalResults,file="oxcalResults/oxcalResults-kde.Rdata")
}
```
####check pit age profiles
```{r}
#pick out 
probdists <- vector("list",length(pit));names(probdists) <- names(pit)
for (i in which(sapply(pit,nrow)==1)){
  probdists[[i]] <- oxcalResults[[i]][[1]]$raw_probabilities
}
for (i in which(sapply(pit,nrow)!=1)){
  probdists[[i]] <- oxcalResults[[i]]$pit$posterior_probabilities
}

#copy and paste
layout(t(matrix(1:12,ncol=3)))
for(z in 1:length(probdists)) {
  if (length(probdists[[z]])==0){
    plot(0,0,main=names(probdists)[z])} else {
    plot(probdists[[z]],main=names(probdists)[z])}}
```


```{r}
load("oxcalResults-kde.Rdata")
boundaries <- data.frame(age=rep(NA,length(oxcalResults)),older=rep(NA,length(oxcalResults)),younger=rep(NA,length(oxcalResults)))
rownames(boundaries) <- names(oxcalResults)
for (i in smallpits){
    begin <- medianProbDist(oxcalResults[[i]]$begin$posterior_probabilities)
    middle <- medianProbDist(oxcalResults[[i]]$Event$posterior_probabilities)
    end <- medianProbDist(oxcalResults[[i]]$end$posterior_probabilities)
    boundaries[i,] <- data.frame(age=middle[1],older=begin[1],younger=end[1])
}
for (i in 1:12){
    begin <- medianProbDist(oxcalResults[[i]]$pit$posterior_probabilities,0.05)
    middle <- medianProbDist(oxcalResults[[i]]$pit$posterior_probabilities,0.5)
    end <- medianProbDist(oxcalResults[[i]]$pit$posterior_probabilities,0.95)
    boundaries[i,] <- data.frame(age=middle[1],older=begin[1],younger=end[1])
}
rm(oxcalResults)
```
###remove bad dates & rerun as necessary
```{r}
unique(goodPits) # 3,13,60,61,67,77,9,16,modern,4,10,81,2,91
i <- which(names(pit)=="61/67")
table(pit[[i]]$Quality)
which(pit[[i]]$Quality%in%c(0,1,"Chitin",">30 kDa"))
test <- unitDates(pit[[i]][-which(pit[[i]]$Quality%in%c(0,1,"Chitin",">30 kDa")),])
#or
i<-which(names(pit)=="61/67")
test<-unitDates.kde(pit[[i]][-which(pit[[i]]$Quality%in%c(0,1,"Chitin",">30 kDa")),])
oxcalResults$`61/67`<-test

begin<-medianProbDist(test$begin$posterior_probabilities)
middle<-medianProbDist(test$Event$posterior_probabilities)
end<-medianProbDist(test$end$posterior_probabilities)
boundaries[i,]<-data.frame(age=middle[1],older=begin[1],younger=end[1])

load("oxcalResults/oxcalResults.Rdata")
oxcalResults[[i]]<-test
save(oxcalResults,file="oxcalResults/oxcalResults.Rdata")
rm(oxcalResults)
```

#Computing morphometric values by interval

##Load morphometric data set and check pit numbers
```{r}
meas<-cleaned
for(i in 1:length(meas)){
  for(j in 1:length(meas[[i]])){
    print(table(meas[[i]][[j]]$Pit))
    print(paste(c(i,j),collapse=","))
    readline(prompt="Press [enter] to continue")
  }
}
#problems in pit numbers:
problems<-rbind(c(2,1),c(2,2),c(2,3),c(3,1),c(3,2),c(3,3),c(6,1),c(8,2),c(21,1),c(22,1),c(24,1))

k<-1
i<-problems[k,1];j<-problems[k,2];c(names(meas[i]),names(meas[[i]][j]));table(meas[[i]][[j]]$Pit)

testphrase <- 0
#replace bad value
replacement <- "modern"
meas[[i]][[j]]$Pit[which(meas[[i]][[j]]$Pit==testphrase)]<-replacement
table(meas[[i]][[j]]$Pit)
#remove bad line
meas[[i]][[j]]<-meas[[i]][[j]][-which(meas[[i]][[j]]$Pit==testphrase),]
table(meas[[i]][[j]]$Pit)

colnames(meas[[16]][[8]])[3:15]<-colnames(meas[[15]][[1]])[3:15]<-gsub("\\.", "_", colnames(meas[[15]][[1]])[3:15])
```
###Change all instances of 61 or 67 to 61/67 and remove NAs
```{r}
for (i in 1:length(meas)){
  for (j in 1:length(meas[[i]])){
    meas[[i]][[j]]<-meas[[i]][[j]][!is.na(meas[[i]][[j]]$Pit),]
    meas[[i]][[j]][meas[[i]][[j]]$Pit%in%c(61,67),"Pit"]<-"61/67"
  }
}
```
###remove defective elements of list and add new species
```{r}
meas<-meas[-16]  #number 16 is modern Gymnogyps californianus, no pit data
meas[[15]]<-meas[[15]][-3] #number 15:3 is Gymnogyps amplus radii and there are only 2
require(openxlsx)
newbirds<-vector(mode="list")
for (i in 1:4){
  newbirds[[i]]<-vector(mode="list")
  newbirds[[i]][[1]]<-read.xlsx(paste0("newbirds/",dir("newbirds/")[i],collapse=""),sheet = "data")
  names(newbirds)[i]<-gsub("\\.xlsx","",dir("newbirds/")[i])
  names(newbirds[[i]])[1]<-"TMT"
}
meas<-append(meas[1:26],newbirds)
save(meas,file="/home/vsyverson/Github/RLB/size_glacial/2023Paleobio/measurements.RData")
load("/home/vsyverson/Github/RLB/size_glacial/2023Paleobio/measurements.RData")
```
###get counts for presentation
```{r}
i<-1;j<-1
testval<-NA
for (i in 1:length(meas)){
  for(j in 1:length(meas[[i]])){
    testval<-unique(c(testval,colnames(meas[[i]][[j]])))
  }
};testval<-testval[-1]

```
##Filter data to the usable pits
###figure out which pits have both dates and measured specimens
```{r}
specPits<-vector()
for(i in 1:length(meas)){
  for(j in 1:length(meas[[i]])){
    specPits<-c(specPits,meas[[i]][[j]]$Pit)
  }
}
sort(table(specPits),decreasing=T) #breakpoint is at 50 specimens
sort(table(specPits[specPits%in%c14$Pit]),decreasing=T)
sort(table(calDates[calDates$Type%in%c("Good","Hiatus"),"Pit"]),decreasing=T)
#remove "modern" and zero-date pits B, 9, 28, 36, 2
goodPits<-sort(c(3,4,13,77,'61/67',16,10,60,91,81))

#change all 61 and 67 to "61/67"
for (i in 1:length(meas)){
  for(j in 1:length(meas[[i]])){
    meas[[i]][[j]]$Pit<-gsub("^67$","61/67",gsub("^61$","61/67",meas[[i]][[j]]$Pit))
  }
}
```

##add pca
```{r}
pca.results<-measpc<-meas
I<-1;J<-1
for (i in I:length(meas)){
  for (j in J:length(meas[[i]])){
    dimensions<-which(!colnames(meas[[i]][[j]])%in%c("CatNo","Side","Sex","Collection","Pit"))
    values<-log(meas[[i]][[j]][,dimensions])
    if (length(dimensions)>1) {      
      pca<-prcomp(as.formula(paste("~",paste(colnames(values),collapse="+"))),
                  data = values, na.action = na.exclude, scale. = T, center = T)
      pca.results[[i]][[j]]<-pca
      flipvec<-apply(pca.results[[i]][[j]]$rotation,2,function(x){
        if(sum(sign(x))<0) {return(-1)} else {return(1)}})
      pca.results[[i]][[j]]$rotation<-
        t(t(pca.results[[i]][[j]]$rotation)*flipvec)
      pca.results[[i]][[j]]$x<-
        t(t(pca.results[[i]][[j]]$x)*flipvec)
      measpc[[i]][[j]]<-cbind(meas[[i]][[j]],pca.results[[i]][[j]]$x)
    1} else {
      measpc[[i]][[j]]<-cbind(meas[[i]][[j]],values)
      names(measpc[[i]][[j]][,"values"])<-"Comp.1"
    }
  }
}
save(measpc,file="measurements_with_pca.RData")
```
###generate table of PC loadings
```{r}
pcLoadings<-data.frame(array(dim=c(53,13)))
row<-1
for (i in 1:length(pca.results)){
  for (j in 1:length(pca.results[[i]])){
    sds<-pca.results[[i]][[j]]$sdev
    sds<-c(sds,rep(0,11-length(sds)))
    pcLoadings[row,]<-c(names(pca.results[i]),names(pca.results[[i]][j]),(sds^2)/sum(sds^2))
    row<-row+1
  }
}
colnames(pcLoadings)<-c("Species","Element",sapply(colnames(pcLoadings)[1:11],
                             function(x) gsub("X","PC",x)))
pcLoadings[19,3:13]<-NA
pcLoadings[,3:13]<-apply(pcLoadings[,3:13],2,as.numeric)
```

###PC scree plot SuppFigA
```{r}
require(data.table)
pcl<-melt(as.data.table(pcLoadings),id=c("Species","Element"))
colnames(pcl)[3:4]<-c("PCNo","loading")
pcl$loading<-as.numeric(pcl$loading)
pcl.plot<-ggplot(pcl,aes(x=PCNo,y=loading)) + geom_boxplot()  + xlab("Principal component number") + ylab("% variance explained")
pcl.plot
dev.print(pdf, "Figures and Tables/SuppFigC - PCA scree.png", width=4,height=4)
```


#Prepare age data for resampling
###load probability distributions
```{r}
load("oxcalResults/oxcalResults.Rdata")
pitProbDist<-vector(mode="list",length=length(oxcalResults))
names(pitProbDist)<-names(oxcalResults)
for (i in 1:length(oxcalResults)){
  if (length(oxcalResults[[i]]$pit)>0){
    pitProbDist[[i]]<-oxcalResults[[i]]$pit$posterior_probabilities
  } else {
    pitProbDist[[i]]<-oxcalResults[[i]]$Event$posterior_probabilities
  }
}

pitProbDist<-probdists
#downsample curves to make them more manageable later
pitProb<-vector(mode="list",length=length(pitProbDist))
names(pitProb)<-names(pitProbDist)
for (i in 1:length(pitProbDist)){
  testx<-as.double(pitProbDist[[i]]$dates);testy<-as.double(pitProbDist[[i]]$probabilities)
  result<-pitProbDist[[i]];eps<-0.000000000000001
  while(nrow(result)>1000){
    eps<-eps*2
    result<-RDP::RamerDouglasPeucker(x=testx,y=testy,epsilon=eps)
  }
  pitProb[[i]]<-result
}
rm(pitProbDist,oxcalResults)
```

####print Supplementary figure A
```{r}
layout(t(matrix(1:12,ncol=3)))
for(z in 1:length(pitProb)) {
  par(mar=c(2.1,2.1,3,1))
  plot(pitProb[[z]],type="l",main=names(pitProb)[z],xaxt="n",
       xlab="",ylab="",xlim=c(range(pitProb[[z]][,1])[1],0))}
    axis(1,at=unique(unlist(climateBins)),
         labels=paste0(unique(unlist(climateBins))/(-1000),"ka"))
mtext("Age probability distribution by pit",side=3,line=-2,outer=T)
dev.print(pdf,"Figures and Tables/pitProbDist.pdf",width=8,height=5)
```

####print Figure 3
```{r}
#copy and paste
plot(0,0,type="n",xlim=c(-50000,0),ylim=c(0,1),main="Pit age probability distributions (normalized)",xlab="Age",ylab="",xaxt="n")
axis(1,at=unique(unlist(climateBins)), labels=paste0(unique(unlist(climateBins))/(-1000),"ka"))
for (z in 1:11){
points(pitProb[[z]][,1],pitProb[[z]][,2]/max(pitProb[[z]][,2]),col=rep(RColorBrewer::brewer.pal(11,"Paired"),2)[z],type="l")
}
abline(v = unique(unlist(halfBins)),lty=2,lwd=0.5,col="gray50")
abline(v = unique(unlist(climateBins)),lty=2,lwd=1)
legend("topleft",legend=paste0("Pit ",names(pitProb)),col=RColorBrewer::brewer.pal(11,"Paired"),bty="n",lty=1,cex=0.7,y.intersp=1.5)

dev.print(pdf,"Figures and Tables/For submission/Figure 3 - pitProbDist-combined.pdf",width=8,height=4)
dev.print(pdf,"Figures and Tables/pitProbDist-combined.pdf",width=8,height=4)
```

###define climate bins
```{r}
source("setup.R")
timeline<-read.xlsx("driveDLs/rlb_2023_data.xlsx",sheet="timescale_plot")
climateBins<-data.frame(Start=timeline[timeline$group=="This study (5 bins)","startKYA"]*-1000,End=timeline[timeline$group=="This study (5 bins)","endKYA"]*-1000)
halfBins<-data.frame(Start=timeline[timeline$group=="This study (9 bins)","startKYA"]*-1000,End=timeline[timeline$group=="This study (9 bins)","endKYA"]*-1000)
```
#Testing the approach
###test bootstrap resampling
####generate test set
```{r}
species<-"Tyto_alba"
t<-meas[species][[1]][[1]] #first element only, no PCs for now
testSpecies<-bootTS(data=t,reps=1000,timebins=halfBins)
testSpecies<-bootTS(data=t,reps=1000,timebins=climateBins)
```
####plot all test series
```{r}
par(mfrow=c(3,1));for(i in 1:length(testSpecies)) {plot(testSpecies[[i]]$paleoTS);abline(v=climateBins$Start[-1],col="lightgrey")}
```
####fit time series models
```{r}
i<-1
compareModels(
  opt.joint.GRW(testSpecies[[i]]$paleoTS,pool=F),
  opt.joint.URW(testSpecies[[i]]$paleoTS,pool=F),
  opt.joint.Stasis(testSpecies[[i]]$paleoTS,pool=F),
  opt.joint.StrictStasis(testSpecies[[i]]$paleoTS,pool=F)
)
```
###test time series length
####try a simulation
```{r}
sim.results<-array(dim=c(100,4))
for (j in 1:100){
  testSim<-sim.GRW(ns=nrow(halfBins),ms=mean(diff(testSpecies[[i]]$paleoTS$mm)),vs=var(diff(testSpecies[[i]]$paleoTS$mm)),vp=mean(testSpecies[[i]]$paleoTS$vv))
  testResult<-compareModels(opt.joint.GRW(testSim,pool=F),opt.joint.URW(testSim,pool=F),opt.joint.Stasis(testSim,pool=F),opt.joint.StrictStasis(testSim,pool=F))
  sim.results[j,]<-testResult$Akaike.wt
}
apply(sim.results,2,mean)
##the time series are too short to pick up signal, oh no
```
Using individual time series is definitely not what the paleoTS software is for, it's too noisy that way
###let's try smaller bins
```{r}
#every 2000  years (n=27)
kyBins<-data.frame(
  Start=seq(from=min(climateBins$Start),to=max(climateBins$End),by=2000)[-28],
  End=seq(from=min(climateBins$Start),to=max(climateBins$End),by=2000)[-1])
#climate bins but with midpoints (n=10)
halfSeq<-sort(unique(c(climateBins$Start,
                       climateBins$End,
                       climateBins$Start[-5]+diff(climateBins$Start)/2,
                       climateBins$End[-5]+diff(climateBins$End)/2)))
halfBins<-data.frame(Start=halfSeq[-11],End=halfSeq[-1])
testSpecies<-bootTS(data=t,reps=1000,timebins=halfBins)
```
2kyr bins not great, but split bins are fine

#Generate all ts results by resampling based on pit probability distributions
###measurement time series
```{r}
TSresults5<-TSresults10<-meas
M<-1
N<-1
for (m in M:length(meas)){
  for (n in N:length(meas[[m]])){
    TSresults5[[m]][[n]]<-bootTS(data=meas[[m]][[n]],reps=1000,timebins=climateBins)
    TSresults10[[m]][[n]]<-bootTS(data=meas[[m]][[n]],reps=1000,timebins=halfBins)
  }
}
```
####fix errors
```{r}
#errors:(7,2);(9,3);(13,1);(15,1)
m<-15;n<-1
names(meas[m]);names(meas[[m]][n])
t<-meas[[m]][[n]]
test<-bootTS(t,reps=1000,timebins=halfBins)
TSresults[[m]][[n]]<-test
#all four run without errors after fixing missing data handling in stat summary function
#check to make sure all runs exist now
for (m in M:length(TSresults)){
  for (n in N:length(TSresults[[m]])){
    if(any(is.na(TSresults[[m]][[n]]))) print(c(m,n))
  }
}
#only missing values in tables, no missing tables
```
###generate pc time series
```{r}
TSresults5.pca<-TSresults10.pca<-meas.pca<-meas
M<-1
N<-1
for (m in M:length(meas.pca)){
  for (n in N:length(meas.pca[[m]])){
    if(all(c(m,n)==c(6,3))){ #gotta skip the bison calcanea, there's only one dimension
      TSresults5.pca[[m]][[n]]<-TSresults5[[m]][[n]]
      TSresults10.pca[[m]][[n]]<-TSresults10[[m]][[n]]
    } else {
      meas.pca[[m]][[n]]<-data.frame(Pit=meas[[m]][[n]][,"Pit"],
                                     pca.results[[m]][[n]]$x)
      TSresults5.pca[[m]][[n]]<-bootTS(data=meas.pca[[m]][[n]],
                                  reps=1000,timebins=climateBins)
      TSresults10.pca[[m]][[n]]<-bootTS(data=meas.pca[[m]][[n]],
                                  reps=1000,timebins=halfBins)
    }
  }
}
```
#fit models to time series
##single result testing
select which one to analyze
```{r}
#species<-"Aquila_chrysaetos" #looks like it should give strict stasis on length
#species<-"Teratornis_merriami" #looks like it should give directional trend on length
t<-meas[-16][species][[1]][[1]] #drop Gymnogyps californianus, it's all age=0
ts<-TSresults[species][[1]][[1]][[1]]$paleoTS
plot(ts);abline(v=climateBins$Start[-1],col="lightgrey")
```
run models
```{r}
test<-compareModels(
  opt.joint.GRW(ts,pool=F),
  opt.joint.URW(ts,pool=F),
  opt.joint.Stasis(ts,pool=F),
  opt.joint.StrictStasis(ts,pool=F),
  fitGpunc(ts,minb=3,pool=F)
)
rownames(test)[5]<-paste(rownames(test)[5],",Shift=",fitGpunc(ts,minb=3,pool=F)$parameters[4],sep="")
test
```
##fit all models
```{r}
require(paleoTS)
TSmodels5<-TSmodels10<-TSresults5
M<-1;N<-1;P<-1;Q<-1
for (m in M:length(TSresults5)){
  for (n in N:length(TSresults5[[m]])){
    for (p in P:length(TSresults5[[m]][[n]])){
      ts<-TSresults5[[m]][[n]][[p]]$paleoTS
      punc<-fitGpunc(ts,minb=2,pool=F) #use if 5 timebins
      mods<-compareModels(
        opt.joint.GRW(ts,pool=F),
        opt.joint.URW(ts,pool=F),
        opt.joint.Stasis(ts,pool=F),
        punc
      )
      rownames(mods)[4]<-paste(rownames(mods)[4],",Shift=",
                               punc$parameters[4],sep="")
      TSmodels5[[m]][[n]][[p]]<-mods
      ts<-TSresults10[[m]][[n]][[p]]$paleoTS
      punc<-fitGpunc(ts,minb=3,pool=F,cl=list(fnscale=-1.00000001)) #use if 10 timebins
      mods<-compareModels(
        opt.joint.GRW(ts,pool=F),
        opt.joint.URW(ts,pool=F),
        opt.joint.Stasis(ts,pool=F,cl=list(fnscale=-1.00000001)),
        punc
      )
      rownames(mods)[4]<-paste(rownames(mods)[4],",Shift=",
                               punc$parameters[4],sep="")
      TSmodels10[[m]][[n]][[p]]<-mods
    }
    for(q in Q:length(TSresults5.pca[[m]][[n]])){
      if(all(c(m,n)==c(6,3))){
        break
      } else {
        ts<-TSresults5.pca[[m]][[n]][[q]]$paleoTS
        punc<-fitGpunc(ts,minb=2,pool=F) #use if 5 timebins
        mods<-compareModels(
          opt.joint.GRW(ts,pool=F),
          opt.joint.URW(ts,pool=F),
          opt.joint.Stasis(ts,pool=F),
          punc
        )
      rownames(mods)[4]<-paste(rownames(mods)[4],",Shift=",
                               punc$parameters[4],sep="")
        TSmodels5[[m]][[n]][[length(TSresults5.pca[[m]][[n]])+q]]<-mods
        names(TSmodels5[[m]][[n]])[length(TSresults5.pca[[m]][[n]])+q]<-
          names(TSresults5.pca[[m]][[n]])[q]
        ts<-TSresults10.pca[[m]][[n]][[q]]$paleoTS
        punc<-fitGpunc(ts,minb=3,pool=F) #use if 10 timebins
        mods<-compareModels(
          opt.joint.GRW(ts,pool=F),
          opt.joint.URW(ts,pool=F),
          opt.joint.Stasis(ts,pool=F,cl=list(fnscale=-1.00000001)),
          punc
        )
      rownames(mods)[4]<-paste(rownames(mods)[4],",Shift=",
                               punc$parameters[4],sep="")
        TSmodels10[[m]][[n]][[length(TSresults10.pca[[m]][[n]])+q]]<-mods
        names(TSmodels10[[m]][[n]])[length(TSresults10.pca[[m]][[n]])+q]<-
          names(TSresults10.pca[[m]][[n]])[q]
      }
    }
  }
}
```

#compile results
##make two big data frames for all the results
```{r}
model.results5<-model.results10<-data.frame(species=NA,element=NA,measurement=NA,bestModel=NA)
M<-1;N<-1;P<-1;i<-1
for (m in M:length(TSmodels5)){
  species<-names(TSmodels5[m])
  for (n in N:length(TSmodels5[[m]])){
    element<-names(TSmodels5[[m]][n])
    for (p in P:length(TSmodels5[[m]][[n]])){
      measurement=names(TSmodels5[[m]][[n]][p])
      bestModel5<-rownames(TSmodels5[[m]][[n]][[p]])[which.max(TSmodels5[[m]][[n]][[p]]$Akaike.wt)]
#      aa<-TSmodels5[[m]][[n]][[p]]
#      bestModel5<-rownames(subset(aa,aa$K>1))[which.max(subset(aa,aa$K>1)$Akaike.wt)]
      model.results5[i,]<-c(species,element,measurement,bestModel5)
      bestModel10<-rownames(TSmodels5[[m]][[n]][[p]])[which.max(TSmodels10[[m]][[n]][[p]]$Akaike.wt)]
#      bb<-TSmodels10[[m]][[n]][[p]]
#      bestModel10<-rownames(subset(bb,bb$K>1))[which.max(subset(bb,bb$K>1)$Akaike.wt)]
      model.results10[i,]<-c(species,element,measurement,bestModel10)
      i<-i+1
    }
  }
}
for (i in 1:4){
  model.results5[,i]<-as.factor(model.results5[,i])
  model.results10[,i]<-as.factor(model.results10[,i])
}
```
##make allBestFits and bestfits
```{r}
model.results<-data.frame(rbind(data.frame(model.results5,L=5),data.frame(model.results10,L=9)))
#save(model.results,TSresults5,TSresults10,TSresults5.pca,TSresults10.pca,TSmodels5,TSmodels10,file="climateBinsResults.RData")
#load(file="climateBinsResults.RData")
allBestFits<-model.results
allBestFits$L<-as.factor(allBestFits$L)
allBestFits<-allBestFits[order(paste(as.character(allBestFits$species),as.character(allBestFits$L))),]
bestfits<-subset(allBestFits, allBestFits$L==9 & !grepl("PC[3-9]", allBestFits$measurement))
bestfits<-subset(allBestFits, allBestFits$L==9)
```
##compare percentages
```{r}
meas10<-subset(allBestFits,!grepl("PC",allBestFits$measurement)&allBestFits$L==9)
meas5<-subset(allBestFits,!grepl("PC",allBestFits$measurement)&allBestFits$L==5)
pc10<-subset(allBestFits,grepl("PC",allBestFits$measurement)&allBestFits$L==9)
pc5<-subset(allBestFits,grepl("PC",allBestFits$measurement)&allBestFits$L==5)

compare.percentages<-function(data1,data2){
  tab1<-rlist::list.rbind(by(data1$bestModel,data1$species,table))
  tab1.perc<-data.frame(t(apply(tab1,1,function(x) return((x/sum(x))*100))))
  tab1.perc$diff<-NA;tab1.perc$L<-data1$L[1]
  tab2<-rlist::list.rbind(by(data2$bestModel,data2$species,table))
  tab2.perc<-data.frame(t(apply(tab2,1,function(x) return((x/sum(x))*100)))) 
  tab2.perc$diff<-NA;tab2.perc$L<-data2$L[1]
  for (i in 1:nrow(tab1.perc)){
    tab1.perc$diff[i]<-tab2.perc$diff[i]<-any(tab1.perc[i,c(1:(ncol(tab1.perc)-2))]!=tab2.perc[i,c(1:(ncol(tab2.perc)-2))])
  }
  result<-rbind(tab1.perc,tab2.perc)
  return(result[order(rownames(result)),])
}
meas.all<-compare.percentages(meas5,meas10)
pca.all<-compare.percentages(pc5,pc10)
```
###make table for publication
```{r}
test1<-cbind(table(meas5$bestModel),table(meas10$bestModel),c(4,2,2,3,4))
#test2<-cbind(table(pc5[pc5$measurement%in%c("PC1","PC2"),]$bestModel),table(pc10[pc10$measurement%in%c("PC1","PC2"),]$bestModel),c(4,2,2,3,4))
test2<-cbind(table(pc5$bestModel),table(pc10$bestModel),c(4,2,2,3,4))
colnames(test1)<-colnames(test2)<-c("5bins","10bins","nparams")
test1<-test1[order(test1[,3]),];test2<-test2[order(test2[,3]),]
resultCounts<-cbind(test1,test2)[,c(6,1,2,4,5)]
colnames(resultCounts)<-c("Model parameter",
                          "Measurements (5 steps)","Measurements (9 steps)",
                          "PCs (5 steps)","PCs (9 steps)")
resultCounts
write.csv(resultCounts,file="Figures and Tables/TableC-FitResults.csv")
```

##examine by category
```{r}
View(subset(bestfits,bestfits$bestModel=="Stasis"))
View(subset(bestfits,bestfits$bestModel=="URW"))
View(subset(bestfits,bestfits$bestModel=="GRW"))
View(subset(bestfits,grepl("Punc",bestfits$bestModel)))
```
##save time series images
###custom plot function
```{r}
makeplot<-function(i,savePDF=F,bins=9,target="Figures and Tables/TSFigures/"){
  all.series<-dplyr::distinct(bestfits[,1:2])
  if(bins==9){subf<-"ninebins"} else if (bins==5){subf<-"fivebins"
  } else {return("oops");break}
  filename<-paste0(target,subf,"/",
                   as.character(all.series$species[i]),"_",
                   as.character(all.series$element[i]),".pdf")
  nspec<-length(which(meas[[as.character(all.series$species[i])]][[as.character(all.series$element[i])]]$Pit%in%goodPits))
  titletext<-paste0("''~italic('",
                    gsub("_"," ",as.character(all.series$species[i])),
                    "')~'",as.character(all.series$element[i]),
                    " (",nspec," specimens)'")
  if (subf=="ninebins") {
    tsdata<-c(TSresults10[[as.character(all.series$species[i])]][[as.character(all.series$element[i])]],
      TSresults10.pca[[as.character(all.series$species[i])]][[as.character(all.series$element[i])]])
    } else if (subf=="fivebins") {
        tsdata<-c(TSresults5[[as.character(all.series$species[i])]][[as.character(all.series$element[i])]],
      TSresults5.pca[[as.character(all.series$species[i])]][[as.character(all.series$element[i])]])
    }
  percvar<-subset(pcLoadings,pcLoadings$Species==as.character(all.series$species[i]) & pcLoadings$Element==as.character(all.series$element[i]))[,3:(2+(length(tsdata)/2))]
  hlMods<-gsub("Punc.*","Punc",as.character(subset(allBestFits,
             allBestFits$species==as.character(all.series$species[i]) & 
             allBestFits$element==as.character(all.series$element[i]) &
             allBestFits$L==bins)$bestModel))
  #plot first Z dimensions
  if(length(tsdata)==14){
    Z<-12} else if(length(tsdata)==12){
    Z<-12} else if(length(tsdata)==10){
    Z<-9} else if(length(tsdata)==8){
    Z<-6} else if(length(tsdata)==6){
    Z<-6} else if(length(tsdata)==4){
    Z<-4} else if(length(tsdata)==2){
    Z<-2} else {Z<-16}
  
  if(Z<=6){
    mat<-t(matrix(1:Z,ncol=2))} else if(Z%in%c(7:9)) {
    mat<-t(matrix(1:Z,ncol=3))} else if(Z>9) {
    mat<-t(matrix(1:Z,ncol=4))}
  
  if(length(tsdata)/2==1){
    par(mar=c(2.1,2.1,3,1),mfrow=c(1,1))
    plot(0,0,type="n",ann=F,axes=F)
    bgcol<-colorpairs[which(colorpairs$model==hlMods[1]),"Meas"]
    rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col=bgcol)
    par(mar=c(2.1,2.1,3,1),new=TRUE)
    plot(tsdata[[1]]$paleoTS,xaxt="n")
    abline(v = unique(unlist(climateBins)),lty=2,lwd=0.5)
    axis(1,at=unique(unlist(climateBins)),
         labels=paste0(unique(unlist(climateBins))/(-1000),"ka"))
    mtext(parse(text=titletext),side=3,line=-2,outer=T,cex=0.8)
    if (savePDF==T) {dev.print(pdf,filename,width=3,height=3)}
  } else {
    layout(mat)
    for (z in 1:Z){
      if(grepl("PC",names(tsdata)[z])) {
        bgcol<-colorpairs[which(colorpairs$model==hlMods[z]),"PC"]
        percvartext<-paste0(round(percvar[z-(length(tsdata)/2)],2)*100,"%",collapse="")
      } else {
        bgcol<-colorpairs[which(colorpairs$model==hlMods[z]),"Meas"]
        percvartext<-""
      }
      par(mar=c(2.1,2.1,3,1))
      plot(0,0,type="n",ann=F,axes=F)
      rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col=bgcol)
      par(mar=c(2.1,2.1,3,1),new=TRUE)
      plot(tsdata[[z]]$paleoTS,xaxt="n")
      abline(v = unique(unlist(climateBins)),lty=2,lwd=0.5)
      axis(1,at=unique(unlist(climateBins)),
           labels=unique(unlist(climateBins))/(-1000),cex=0.9)
      mtext(percvartext,side=3,adj=1,col="grey",cex=0.6)
    }
    mtext(parse(text=titletext),side=3,line=-2,outer=T)
    if (savePDF==T) {dev.print(pdf,filename,width=ncol(mat)*2,
            height=nrow(mat)*2)}
  }
}
```
###set color palette
```{r}
colorpairs<-data.frame(model=c("GRW","Punc","Stasis","URW"),
                       Meas=c("thistle1","mistyrose1","azure1","lightyellow"),
                       PC=c("thistle2","mistyrose2","azure2","palegoldenrod"))
```
###print all
```{r}
target<-"Figures and Tables/TSFigures/all/"
for (i in 1:nrow(all.series)) {
  makeplot(i,savePDF=T,bins=5,target=target)
  makeplot(i,savePDF=T,bins=9,target=target)
}
rm(target)
```
###print by model
####sort by best fit model
```{r}
GRW<-(dplyr::distinct(subset(bestfits,bestfits$bestModel=="GRW")[,1:2]))
Punc<-(dplyr::distinct(subset(bestfits,grepl("Punc",bestfits$bestModel))[,1:2]))
test<-dplyr::distinct(subset(bestfits, bestfits$bestModel=="GRW" | grepl("Punc", bestfits$bestModel))[,1:2])
Stasis<-dplyr::distinct(subset(bestfits, !(apply(bestfits[,1:2], 1, paste0, collapse=",") %in% apply(test, 1, paste0, collapse=",")) & bestfits$bestModel=="Stasis")[,1:2])
URW<-dplyr::distinct(subset(bestfits, !(apply(bestfits[,1:2], 1, paste0, collapse=",") %in% apply(test, 1, paste0, collapse=",")) & bestfits$bestModel=="URW")[,1:2])
uniform<-data.frame(rbind(anti_join(Stasis,URW),anti_join(URW,Stasis)),
                    model=c(rep("Stasis",nrow(anti_join(Stasis,URW))),
                            rep("URW",nrow(anti_join(URW,Stasis)))))
```
####generate figures
```{r}
#generate figures
mod<-"Punc" #pick a set, reference it as a string
target<-paste0("Figures and Tables/TSFigures/mod/",mod,"/",collapse = "")
modrows<-na.exclude(match(
  apply(eval(parse(text = mod)),1,paste0,collapse=" "),
  apply(all.series,1,paste0,collapse=" ")))
for (i in modrows) {
  makeplot(i,savePDF=T,bins=5,target=target)
  makeplot(i,savePDF=T,bins=9,target=target)
}
rm(target)
```

###print by ecological category
####define categories
```{r}
carnivorans<-c("Aenocyon_dirus","Lynx_rufus","Panthera_atrox","Puma_concolor","Smilodon_fatalis")
herbivores<-c("Bison_antiquus","Camelops_hesternus","Equus_occidentalis","Paramylodon_harlani")
birdsofprey<-c("Aquila_chrysaetos","Buteo_jamaicensis","Buteo_regalis","Buteo_swainsoni","Buteogallus_fragilis","Circus_hudsoni","Caracara_prelutosus","Haliaeetus_leucocephalus","Spizaetus_grinnelli")
owls<-c("Asio_otus","Athene_cunicularia","Bubo_virginianus","Tyto_alba")
vultures<-c("Gymnogyps_amplus","Neophrontops_americanus","Coragyps_occidentalis","Teratornis_merriami")
passerines<-c("Corvus_corax","Pica_nuttalli","Sturnella_neglecta")
extinct<-c("Aenocyon_dirus","Panthera_atrox","Smilodon_fatalis","Bison_antiquus","Camelops_hesternus","Equus_occidentalis","Paramylodon_harlani","Buteogallus_fragilis","Caracara_prelutosus","Gymnogyps_amplus","Neophrontops_americanus","Teratornis_merriami")
```

####generate figures
```{r}
cat<-"owls" #pick a category
target<-paste0("Figures and Tables/TSFigures/eco/",cat,"/",collapse = "")
ecorows<-which(all.series$species%in%eval(parse(text = cat)))
for (i in ecorows){
  makeplot(i,savePDF=T,bins=5,target=target)
  makeplot(i,savePDF=T,bins=9,target=target)
}
rm(target)
```


#Illustrations
##paleoclimate timeline
```{r}
source("setup.R")
timeline<-read.xlsx("driveDLs/rlb_2023_data.xlsx",sheet="timescale_plot")
timeline$start<-as.Date(timeline$start,format="%m/%d/%Y")
timeline$end<-as.Date(timeline$end,format="%m/%d/%Y")
timeline$event<-gsub("_","\\\n",timeline$event)
timeline$group<-gsub("_","\\\n",timeline$group)
timeline.plot<-gg_vistime(data=timeline,
           col.event="event",
           col.start="start",
           col.end="end",
           col.group="group",
           col.color="color",
           linewidth = 14) +
  theme(axis.text.x=element_blank(), axis.ticks.x = element_blank())
timeline.plot 
dev.print(pdf, "Figures and Tables/FigA - Climate.pdf", width=12, height=7.5)
```
##new pit age ranges
```{r}
source("setup.R")
chronplot<-read.xlsx("driveDLs/rlb_2023_data.xlsx",sheet="new_chronology_plot")
chronplot$color<-rainbow(nrow(chronplot))
chronplot$start<-as.Date(chronplot$start,format="%m/%d/%Y")
chronplot$end<-as.Date(chronplot$end,format="%m/%d/%Y")
chronplot.plot<-gg_vistime(data=chronplot,
           col.event="event",
           col.start="start",
           col.end="end",
           col.group="group",
           col.color="color",
           optimize_y=T)
chronplot.plot
```
##14C date plot
###calibrate dates
```{r}
source("setup.R")
uncalDates<-c14
uncalDates$Uncal14CYBP<-as.numeric(uncalDates$Uncal14CYBP)
uncalDates<-uncalDates[!is.na(uncalDates$Uncal14CYBP),]
uncalDates$Uncal14CSE<-as.numeric(uncalDates$Uncal14CSE)
uncalDates[uncalDates$Pit%in%c(61,67),"Pit"]<-"61/67"
usePits<-c("91","3","4","10","16","61/67","60","77","13","9","81","2")
uncalDates<-uncalDates[uncalDates$Pit%in%usePits,]
uncalDates$Pit<-as.factor(uncalDates$Pit)
pitOrder<-names(sort(table(uncalDates$Pit),decreasing=T))
factorOrder<-match(pitOrder,levels(uncalDates$Pit))
uncalDates$Pit<-factor(uncalDates$Pit,levels(uncalDates$Pit)[factorOrder])

calibrateSingleDate<-function(x){
  res<-oxcalCalibrate(as.numeric(x["Uncal14CYBP"]),
                      as.numeric(x["Uncal14CSE"]))[[1]]
  median<-medianProbDist(res$raw_probabilities)[1]
  max<--(min(res$sigma_ranges$two_sigma$start)-1950)
  min<--(max(res$sigma_ranges$two_sigma$end)-1950)
  return(c(median,max,min))
  }
calDates<-data.frame(SpecNo=uncalDates$SpecNo,
                     SampNo=uncalDates$SampleNo,
                     Pit=as.factor(uncalDates$Pit),
                     Quality=uncalDates$Quality,
                     median=rep(NA,nrow(uncalDates)),
                     max=rep(NA,nrow(uncalDates)),
                     min=rep(NA,nrow(uncalDates)))
i<-0
i->I
for (i in I:nrow(uncalDates)){
  calDates[i,c("median","max","min")]<-calibrateSingleDate(uncalDates[i,])
}
calResults<-data.frame(t(apply(uncalDates,1,calibrateSingleDate)))
colnames(calResults)<-c("median","max","min")
calDates<-data.frame(SpecNo=uncalDates$SpecNo,
                     SampNo=uncalDates$SampleNo,
                     Pit=as.factor(uncalDates$Pit),
                     Quality=uncalDates$Quality,
                     calResults[,c("median","max","min")])
```

```{r}
#get date correspondence
load("oxcalResults/oxcalResults.Rdata")
intcal20<-data.frame(bp=oxcalResults$'10'$IntCal20$cal_curve$bp,bc=oxcalResults$'10'$IntCal20$cal_curve$bc,sigma=oxcalResults$'10'$IntCal20$cal_curve$sigma)
hiatus<-intcal20[between(intcal20$bp,16000,18500),]
hiatusCalBP<--range(c(hiatus$bc-hiatus$sigma-1950,hiatus$bc+hiatus$sigma-1950))
```
###clean up data
```{r}
calDates$Type<-rep("Good",nrow(calDates))
calDates[is.na(calDates$Quality),"Quality"]<-""
calDates[calDates$Quality%in%c(0,1,"&gt;30 kDa"),"Type"]<-"Low Quality"
calDates[calDates$Quality=="Chitin","Type"]<-"Chitin"
calDates[calDates$Quality=="Wood","Type"]<-"Wood"
calDates$Type<-factor(calDates$Type,c("Good","Low Quality","Chitin","Wood"))
```

###make plot
```{r}
datevis<-ggplot(data=calDates,mapping = aes(x=median,y=1,color=Type)) + 
  facet_grid(rows=vars(Pit)) + 
  theme(panel.grid.major.y= element_blank(),
        panel.grid.minor.y =element_blank(),
        axis.text.y=element_blank(),axis.ticks.y=element_blank()) +
  scale_x_reverse(breaks=seq(0,55000,10000),minor_breaks=seq(0,55000,5000)) +
  geom_jitter(width=0,height=0.05) + scale_color_manual(values= c("black","grey70","lightsteelblue3","darkseagreen4")) +
  geom_vline(xintercept = unique(-1*unlist(halfBins)),linetype=3) +
  geom_vline(xintercept = unique(-1*unlist(climateBins))) +
  geom_vline(xintercept = hiatusCalBP, color="red") +
  xlab("Age (cal YBP)") + ylab ("Pit #") + 
#  labs(linetype="Primary climate bins","Subdivided time bins") +
  labs(color="Date quality",) + ggtitle("Calibrated 14C dates by pit")
datevis
dev.print(pdf, "Figures and Tables/FigB - Dates - 12x7.5.pdf", width=12, height=7.5)
dev.print(pdf, "Figures and Tables/FigB - Dates - 8x5.pdf", width=8, height=5)
```

```{r}
uncalDates$Type<-rep("Good",nrow(uncalDates))
uncalDates[uncalDates$Quality%in%c(0,1),"Type"]<-"Low Quality"
uncalDates[uncalDates$Quality=="Chitin","Type"]<-"Chitin"
uncalDates[dplyr::between(uncalDates$Uncal14CYBP,16000,18500) & uncalDates$Type=="Good","Type"]<-"Hiatus"
uncalDates$Type<-factor(uncalDates$Type,c("Good","Low Quality","Chitin","Hiatus"))
```

###uncalibrated dates plot
```{r}
datevis_uncal<-ggplot(data=uncalDates,mapping = aes(x=Uncal14CYBP,y=1,color=Type)) + 
  facet_grid(rows=vars(Pit)) + 
  theme(panel.grid.major.y= element_blank(),
        panel.grid.minor.y =element_blank(),
        axis.text.y=element_blank(),axis.ticks.y=element_blank()) +
  scale_x_reverse(breaks=seq(0,55000,10000),minor_breaks=seq(0,55000,5000)) +
  geom_jitter(width=0) + scale_color_manual(values= c("black","grey70","lightsteelblue3","red")) +
  geom_vline(xintercept = unique(-1*unlist(halfBins)),linetype=3) +
  geom_vline(xintercept = unique(-1*unlist(climateBins))) +
  geom_vline(xintercept = c(18500,16000), color="red") +
  xlab("Age (uncal 14C YBP)") + ylab ("Pit #") + 
#  labs(linetype="Primary climate bins","Subdivided time bins") +
  labs(color="Date quality",) + ggtitle("Uncalibrated 14C dates by pit")
datevis_uncal
```
##timebin by pit
```{r}
M<-1;N<-1
bdist<-vector(mode="list",length=nrow(all.series));names(bdist)<-apply(all.series[,1:2],1,paste0,collapse = " ")
for (m in M:length(meas)){
  for(n in N:length(meas[[m]])){
    i<-which(all.series$species==names(meas[m]) & all.series$element==names(meas[[m]][n]))
    bdist[[i]]<-as.data.frame.matrix(TSresults5[[m]][[n]][[1]]$dist)
    bdist[[i]]<-apply(bdist[[i]],2,function(x) x/sum(x))
  }
}
```


```{r}
nbins<-5
bdist.summary<-data.frame(array(dim=c(length(goodPits),nbins)))
for (intno in 1:nbins) {
  int<-sapply(bdist,function(x) return(x[,intno]))
  addmissing<-function(x) {
    missing<-goodPits[which(!goodPits%in%names(x))]
    result<-c(x,rep(0,length(missing)));names(result)<-c(names(x),missing)
    return(result[order(names(result))])
  } 
  for (i in 1:length(int)) int[[i]]<-addmissing(int[[i]])
  int.stack<-t(array(unlist(int),dim=c(length(goodPits),length(int))))
  colnames(int.stack)<-goodPits;rownames(int.stack)<-names(int)
  bdist.summary[,intno]<-apply(int.stack,2,sum)/length(int)
}
round(bdist.summary,2)*100
```


```{r}
rownames(bdist.summary9)<-goodPits;colnames(bdist.summary9)<-c("Glac. A","Glac. B","LGM A","LGM B","DG A","DG B","Trans. A","Trans. B","Holocene")
rownames(bdist.summary5)<-goodPits;colnames(bdist.summary5)<-c("Glaciation","LGM","Deglaciation","Transition","Holocene")
```

```{r}
require(ggplot2);require(data.table)
melted5<-reshape::melt(as.matrix(bdist.summary5));melted$X2<-as.factor(melted$X2)
melted9<-reshape::melt(as.matrix(bdist.summary9));melted$X2<-as.factor(melted$X2)
```

###make plot
```{r}
grob5<-ggplot(melted5,aes(x=X2,y=value,fill=X1)) + 
  geom_bar(position = "stack",stat="identity",show.legend = F) +
  xlab("Time bin") + labs(fill="Pit #") + 
  scale_fill_manual(values=as.vector(pals::tol())) +
  ggtitle("Pit proportions per time bin, 5 bins") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
grob9<-ggplot(melted9,aes(x=X2,y=value,fill=X1)) + 
  geom_bar(position = "stack",stat="identity") +
  xlab("Time bin") + labs(fill="Pit #") + 
  scale_fill_manual(values=as.vector(pals::tol())) +
  ggtitle("Pit proportions per time bin, 9 bins") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
grid.arrange(grob5,grob9,nrow=1,widths=c(1,1.2))

dev.print(pdf, "Figures and Tables/PitProportions.pdf", width=12, height=7.5)
```


#Tables
##Time series (Suppl. Table AA)
```{r}
SuppAA<-data.frame(apply(unique(allBestFits[,1:3]),1:2,as.character))
SuppAA<-subset(SuppAA,!grepl("PC",SuppAA$measurement))
SuppAA$measurements<-apply(SuppAA,1,function(x)
  paste0(SuppAA[which(SuppAA$species==x["species"] & 
          SuppAA$element==x["element"]),"measurement"],collapse=", "))
SuppAA<-dplyr::distinct(SuppAA[,-which(colnames(SuppAA)=="measurement")])
SuppAA$count<-apply(SuppAA,1,function(x){nrow(meas[[gsub(" ","_",x["species"])]][[x["element"]]])})

source("setup.R")
species<-read.xlsx("driveDLs/rlb_2023_data.xlsx",sheet="species")
SuppAA$species<-gsub("_"," ",SuppAA$species)
matchnames<-apply(rbind(match(SuppAA$species,species$Name.used.in.publication),match(SuppAA$species,species$Species.name)),2,function(x) (if(is.na(x[1])) {return(x[2])} else {return(x[1])}))
SuppAA$extant<-species$Extant[matchnames]

SuppAA$element<-gsub("CMC","Carpometacarpus",SuppAA$element)
SuppAA$element<-gsub("TMT","Tarsometatarsus",SuppAA$element)
SuppAA$element<-gsub("humerus","Humerus",SuppAA$element)
SuppAA$element<-gsub("femur","Femur",SuppAA$element)
SuppAA$element<-gsub("astragalus","Astragalus",SuppAA$element)
SuppAA$element<-gsub("patella","Patella",SuppAA$element)
SuppAA$element<-gsub("mt3","Metatarsal 3",SuppAA$element)
SuppAA$element<-gsub("MT3","Metatarsal 3",SuppAA$element)
SuppAA$element<-gsub("mc3","Metacarpal 3",SuppAA$element)
SuppAA$element<-gsub("MC3","Metacarpal 3",SuppAA$element)
SuppAA$element<-gsub("m1","Molar 1",SuppAA$element)
View(SuppAA)

pubs<-read.xlsx("driveDLs/rlb_2023_data.xlsx",sheet="publications")
SuppAA$reference<-sapply(SuppAA$species,function(x) pubs[grep(x,pubs$Taxa),"Ref"])

names(SuppAA)<-c("Species name","Skeletal element","Measurements","Count","Extant?","Reference")

write.csv(SuppAA,"Figures and Tables/SuppTableAA.csv",row.names = F)
```

##Climate proxy breakpoints (Suppl. Table CC)
```{r}
source("setup.R")
timeline<-read.xlsx("driveDLs/rlb_2023_data.xlsx",sheet="timescale_plot")
SuppCC<-data.frame(timeline[,1:7])
names(SuppCC)<-c("Source","Region","Interval","Start (14C ka)","End (14C ka)","Start (cal ka)","End (cal ka)")
write.csv(SuppCC,file="Figures and Tables/SuppCC.csv",row.names = F)
```
##Date ranges (Table 2)
```{r}
subset(boundaries,rownames(boundaries)%in%goodPits)[c("3","4","9","10","13","16","60","61/67","77","81","91"),c(2,1,3)]
```

##All dates (Suppl. Table BB)
```{r}
SuppBB<-data.frame(uncalDates[,1:8],
                  calDates[match(calDates$SampNo,uncalDates$SampleNo),5:7],
                  uncalDates[,9:10])
SuppBB[dplyr::between(SuppB$median,hiatusCalBP[2],hiatusCalBP[1]),]
write.csv(SuppBB,file="Figures and Tables/SuppBB.csv",row.names = F)
```

##GRW results (Table 4)
```{r}
Table4<-data.frame(apply(subset(bestfits,bestfits$bestModel=="GRW")[,1:3],1:2,as.character))
Table4$direction<-apply(Table4,1,function(x){
  if(grepl("PC",x["measurement"])) {
    data<-TSresults10.pca[[x["species"]]][[x["element"]]][[x["measurement"]]]$table
  } else {
    data<-TSresults10[[x["species"]]][[x["element"]]][[x["measurement"]]]$table
  }
  return(sign(lm(data$means~data$ages)$coefficients[2]))
})
Table4<-distinct(Table4); Table4->longTable4
Table4$measurements<-apply(Table4,1,function(x) {
  {paste0(Table4[which(Table4$species==x["species"] & Table4$element==x["element"] & Table4$direction==as.numeric(x["direction"])),"measurement"], collapse=", ")}
  })

Table4[which(Table4$measurements==""),"measurements"]<-Table4[which(Table4$measurements==""),"measurement"]

Table4<-dplyr::distinct(Table4[,c("species","element","measurements","direction")])
Table4$species<-gsub("_"," ",Table4$species)
Table4$direction<-gsub("-1","smaller",Table4$direction)
Table4$direction<-gsub("1","larger",Table4$direction)
Table4$direction<-gsub("0","",Table4$direction)
write.csv(Table4,"Figures and Tables/Table4-direction.csv",row.names = F)

```

```{r}
colnames(longTable4)<-c("Species","Element","Measurement","Direction")
smaller<-subset(longTable4,longTable4$Direction==-1)
bigger<-subset(longTable4,longTable4$Direction==1)

test<-merge(subset(bigger,grepl("PC",bigger$Measurement)),pcLoadings,by=c("Species","Element"))
for (i in 1:nrow(test)){ test[i,which(!colnames(test)==as.character(test[i,"Measurement"]))][-c(1:4)]<-0
}
sum(test[,5:15]) #smaller: 4.035056; bigger: 3.211288

```

# Alternate analysis (following suggestions in review from Hunt)
## stash old data
```{r}
save(TSresults10,TSresults10.pca,TSresults5,TSresults5.pca,file = "combined_TS_results.RData")
rm(TSresults10,TSresults10.pca,TSresults5,TSresults5.pca)
```

## define new functions
```{r}
source("functions.R")
```

## make all time series bootstrap replicates
```{r}
TSboot5.pca <- TSboot10.pca <- meas.pca <- TSboot5 <- TSboot10 <- 
  vector(mode = "list",length = length(meas))
names(TSboot5.pca) <- names(TSboot10.pca) <- names(meas.pca) <- names(TSboot5) <- names(TSboot10) <- names(meas)

M <- 1
N <- 1
for (m in M:length(meas)) {
  TSboot5[[m]] <- TSboot10[[m]] <- TSboot5.pca[[m]] <- TSboot10.pca[[m]] <- vector(mode = "list",length = length(meas[[m]]))
  names(TSboot5[[m]]) <- names(TSboot10[[m]]) <- names(TSboot5.pca[[m]]) <- names(TSboot10.pca[[m]]) <- names(meas[[m]])
  for (n in N:length(meas[[m]])) {
    TSboot5[[m]][[n]] <- bootReps(data = meas[[m]][[n]],reps = 1000,timebins = climateBins)
    TSboot10[[m]][[n]] <- bootReps(data = meas[[m]][[n]],reps = 1000,timebins = halfBins)
    names(TSboot5[[m]][n]) <- "meas.short"
    names(TSboot10[[m]][n]) <- "meas.long"
    if (all(c(m,n) == c(6,3))) { #skip PCA for bison calcanea, there's only one dimension
      TSboot5.pca[[m]][[n]] <- TSboot5[[m]][[n]]
      TSboot10.pca[[m]][[n]] <- TSboot10[[m]][[n]]
    } else {
      meas.pca[[m]][[n]] <- data.frame(Pit = meas[[m]][[n]][,"Pit"],
                                     pca.results[[m]][[n]]$x)
      TSboot5.pca[[m]][[n]] <- bootReps(data = meas.pca[[m]][[n]],
                                  reps = 1000,timebins = climateBins)
      TSboot10.pca[[m]][[n]] <- bootReps(data = meas.pca[[m]][[n]],
                                  reps = 1000,timebins = halfBins)
    }
    names(TSboot5.pca[[m]][n]) <- "pca.short"
    names(TSboot10.pca[[m]][n]) <- "pca.long"
  }
}
```


```{r}
save(TSboot5,file = "rep_TS/TSboot5.RData")
save(TSboot10,file = "rep_TS/TSboot10.RData")
save(TSboot5.pca,file = "rep_TS/TSboot5.pca.RData")
save(TSboot10.pca,file = "rep_TS/TSboot10.pca.RData")
rm(TSboot5,TSboot5.pca,TSboot10,TSboot10.pca)
```

## get model outcomes for all replicates of all time series
don't forget to report model parameter estimates
```{r}
TSbootmodels5 <- TSbootmodels10 <- TSbootmodels5.pca <- TSbootmodels10.pca <- vector(mode="list",length=length(meas))
Z <- 1;M <- 1;N <- 1;P <- 1;Q <- 1
m <- n <- z <- p <- q <- 1
#m=species, n=element, z=replicate, p/q=dimension
```

```{r}
modelRepTS <- function(ts) {
  library(paleoTS)
  tsLength <- length(ts$tt)
  if (any(ts$vv == 0)) { pool <- TRUE } else { pool <- FALSE } 
  if (tsLength <= 5) {
    punc <- fitGpunc(ts,minb = 2,pool = pool)
  } else {
    punc <- fitGpunc(ts,minb = 3,pool = pool,cl = list(fnscale = -1.00000001))
  }
  grw <- opt.joint.GRW(ts,pool = pool)
  urw <- opt.joint.URW(ts,pool = pool)
  stasis <- opt.joint.Stasis(ts,pool = pool,cl = list(fnscale = -1.00000001))
  params <- list(GRW = grw$parameters,
                 URW = urw$parameters,
                 Stasis = stasis$parameters,
                 Punc = punc$parameters)
  compare <- compareModels(grw, urw, stasis, punc)
  rownames(compare)[4] <- paste(rownames(mods)[4], ",Shift=",
                             punc$parameters[4], sep = "")
  return(list(compare = compare,params = params))
}
```

```{r}
failTS <- vector(mode="list")
failTS.index <- data.frame(array(data = NA, dim = c(1,5)))
# datacheck/debug block
i <- length(failTS) + 1
failTS.index[i,] <- c(m,n,z,p,q)
TSboot5[[m]][[n]][[z]][[p]]$table
failTS[[i]] <- TSboot5[[m]][[n]][[z]][[p]]$paleoTS


```

```{r}
load("rep_TS/TSboot5.RData")
for (m in M:length(TSboot5)) {
  for (n in N:length(TSboot5[[m]])) {
    for (z in Z:length(TSboot5[[m]][[n]])) {
      TSbootmodels5[[m]][[n]][[z]] <- vector(mode = "list",length = 1000)
      for (p in P:length(TSboot5[[m]][[n]][[z]])) {
        TSbootmodels5[[m]][[n]][[z]][[p]] <- 
          modelRepTS(TSboot5[[m]][[n]][[z]][[p]]$paleoTS)
      }
    }
  } 
}
rm(TSboot5)
```


```{r}
load("rep_TS/TSboot10.RData")
for (m in M:length(TSboot10)) {
  for (n in N:length(TSboot10[[m]])) {
    for (z in Z:length(TSboot10[[m]][[n]])) {
      for (p in P:length(TSboot10[[m]][[n]][[z]])) {
        TSbootmodels10[[m]][[n]][[z]][[p]] <- 
          modelRepTS(TSboot10[[m]][[n]][[z]][[p]]$paleoTS)
        names(TSbootmodels10[[m]][[n]][[z]][[p]]) <- "meas.long"
      }}}}
```


```{r}
load("rep_TS/TSboot5.pca.RData")
for (m in M:length(TSboot5.pca)) {
  for (n in N:length(TSboot5.pca[[m]])) {
    for (z in Z:length(TSboot5.pca[[m]][[n]])) {
      for (q in Q:length(TSboot5.pca[[m]][[n]][[z]])) {
        if (all(c(m,n) == c(6,3))) {
          break
        } else {
          TSbootmodels5.pca[[m]][[n]][[z]][[q]] <- 
            modelRepTS(TSboot5.pca[[m]][[n]][[z]][[q]]$paleoTS)
          names(TSbootmodels5.pca[[m]][[n]][[z]][[q]]) <- "pca.short"
        }}}}}
```


```{r}
load("rep_TS/TSboot10.pca.RData")
for (m in M:length(TSboot10.pca)) {
  for (n in N:length(TSboot10.pca[[m]])) {
    for (z in Z:length(TSboot10.pca[[m]][[n]])) {
      for (p in P:length(TSboot10.pca[[m]][[n]][[z]])) {
        if (all(c(m,n) == c(6,3))) {
          break
        } else {
          TSbootmodels10.pca[[m]][[n]][[z]][[q]] <- 
            modelRepTS(TSboot10.pca[[m]][[n]][[z]][[q]]$paleoTS)
          names(TSbootmodels10.pca[[m]][[n]][[z]][[q]]) <- "pca.long"
        }}}}}
```


```{r}
names(TSbootmodels5) <- names(TSbootmodels10) <- names(TSbootmodels5.pca) <- names(TSbootmodels10.pca) <- names(meas)
Z <- 1;M <- 1;N <- 1;P <- 1;Q <- 1
#m=species, n=element, z=replicate, p/q=dimension

for (m in M:length(TSboot5)) {
  names(TSbootmodels5[[m]]) <- names(TSbootmodels10[[m]]) <- 
    names(TSbootmodels5.pca[[m]]) <- names(TSbootmodels10.pca[[m]]) <- 
    names(meas[[m]])
  for (n in N:length(TSboot5[[m]])) {
    names(TSbootmodels5[[m]][[n]]) <- names(TSbootmodels10[[m]][[n]]) <- 
      names(TSbootmodels5.pca[[m]][[n]]) <- names(TSbootmodels10.pca[[m]][[n]]) <- 
      names(meas[[m]][[n]][4:ncol(meas[[m]][[n]])])
    for (z in Z:length(TSboot5[[m]][[n]])) {
      names(TSbootmodels5[[m]][[n]][[z]]) <- names(TSbootmodels10[[m]][[n]][[z]]) <-
        names(TSbootmodels5.pca[[m]][[n]][[z]]) <-
        names(TSbootmodels10.pca[[m]][[n]][[z]]) <- 1:1000
    }
  }
}
```

## summarize range of model outcomes for each time series
```{r}

```

